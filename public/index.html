<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>SQL Server API Builder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  </head>
  <body class="bg-gray-50 min-h-screen">
    <div id="app" class="min-h-screen flex flex-col"></div>
    <script type="text/babel">
      const { useState, useEffect } = React;

      function App() {
        const [schema, setSchema] = useState(null);
        const [error, setError] = useState('');
        const [step, setStep] = useState(1);
        const [table, setTable] = useState('');
        const [selectedCols, setSelectedCols] = useState([]);
        const [aliases, setAliases] = useState({});
        const [loading, setLoading] = useState(false);

        useEffect(() => {
          fetch('/schema')
            .then((r) => r.json())
            .then(setSchema)
            .catch(() => setError('Failed to load schema'));
        }, []);

        const handleSelectTable = (t) => {
          setTable(t);
          setSelectedCols([]);
          setAliases({});
          setStep(2);
          setError('');
        };

        const toggleColumn = (c) => {
          setSelectedCols((prev) => {
            if (prev.includes(c)) {
              const out = prev.filter((x) => x !== c);
              const newAliases = { ...aliases };
              delete newAliases[c];
              setAliases(newAliases);
              return out;
            }
            return [...prev, c];
          });
        };

        const handleAliasChange = (c, val) => {
          setAliases((a) => ({ ...a, [c]: val }));
        };

        const validateColumns = () => {
          if (!selectedCols.length) {
            setError('Select at least one column');
            return;
          }
          setError('');
          setStep(3);
        };

        const handleGenerate = async () => {
          const mapping = {};
          selectedCols.forEach((c) => {
            const v = aliases[c] && aliases[c].trim();
            mapping[c] = v || c;
          });
          const payload = { [table]: { columns: mapping } };
          setLoading(true);
          setError('');
          try {
            const res = await fetch('/configure', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload),
            });
            if (!res.ok) throw new Error('Server error');
            alert('API generated! Documentation available at /docs');
            setStep(1);
            setTable('');
            setSelectedCols([]);
            setAliases({});
          } catch (e) {
            setError('Error generating API');
          } finally {
            setLoading(false);
          }
        };

        const routeBase = table ? `/api/v1/${table}` : '';

        return (
          <div className="flex-grow container mx-auto p-4 pb-24">
            <h1 className="text-2xl font-bold mb-6">SQL Server API Builder</h1>
            {error && (
              <div className="bg-red-100 text-red-800 p-2 mb-4 rounded">
                {error}
              </div>
            )}
            {step === 1 && schema && (
              <div>
                <h2 className="text-lg font-semibold mb-2">Step 1: Select a table</h2>
                <div className="space-y-2">
                  {Object.keys(schema).map((t) => (
                    <button
                      key={t}
                      onClick={() => handleSelectTable(t)}
                      className="w-full text-left p-3 bg-white rounded shadow hover:bg-gray-50"
                    >
                      {t}
                    </button>
                  ))}
                </div>
              </div>
            )}
            {step === 2 && (
              <div>
                <h2 className="text-lg font-semibold mb-4">Step 2: Select columns for {table}</h2>
                <div className="space-y-2 mb-4">
                  {schema[table].map((c) => (
                    <label
                      key={c}
                      className="flex items-center space-x-2 bg-white p-2 rounded shadow"
                    >
                      <input
                        type="checkbox"
                        checked={selectedCols.includes(c)}
                        onChange={() => toggleColumn(c)}
                      />
                      <span>{c}</span>
                    </label>
                  ))}
                </div>
                <div className="flex space-x-2">
                  <button onClick={() => setStep(1)} className="px-4 py-2 rounded border">Back</button>
                  <button
                    onClick={validateColumns}
                    className="px-4 py-2 rounded bg-blue-600 text-white"
                  >
                    Next
                  </button>
                </div>
              </div>
            )}
            {step === 3 && (
              <div>
                <h2 className="text-lg font-semibold mb-4">Step 3: Rename fields</h2>
                <div className="space-y-2 mb-4">
                  {selectedCols.map((c) => (
                    <div
                      key={c}
                      className="flex items-center space-x-2 bg-white p-2 rounded shadow"
                    >
                      <span className="w-1/3 truncate" title={c}>{c}</span>
                      <input
                        className="border rounded p-1 flex-1"
                        value={aliases[c] !== undefined ? aliases[c] : c}
                        onChange={(e) => handleAliasChange(c, e.target.value)}
                      />
                    </div>
                  ))}
                </div>
                <div className="mb-4">
                  <h3 className="font-semibold mb-1">Routes to be created</h3>
                  <ul className="list-disc list-inside text-sm">
                    <li>{`GET ${routeBase}`}</li>
                    <li>{`GET ${routeBase}/:id`}</li>
                    <li>{`POST ${routeBase}`}</li>
                    <li>{`PUT ${routeBase}/:id`}</li>
                    <li>{`DELETE ${routeBase}/:id`}</li>
                  </ul>
                </div>
                <div className="flex space-x-2">
                  <button onClick={() => setStep(2)} className="px-4 py-2 rounded border">Back</button>
                </div>
              </div>
            )}
            <button
              disabled={step !== 3 || loading}
              onClick={handleGenerate}
              className="fixed bottom-4 right-4 bg-blue-600 text-white px-6 py-3 rounded shadow-lg"
            >
              {loading ? 'Generating...' : 'Generate API'}
            </button>
          </div>
        );
      }

      ReactDOM.render(<App />, document.getElementById('app'));
    </script>
  </body>
</html>
